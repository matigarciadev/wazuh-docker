global
log stdout format raw local0
maxconn 20000

defaults
log global
mode tcp
option tcplog
timeout connect 5s
timeout client  2h
timeout server  2h

# Use Docker's embedded DNS (127.0.0.11) and don't die if DNS isn't ready yet
resolvers docker
nameserver dockerdns 127.0.0.11:53
resolve_retries 30
timeout retry 1s
hold valid 10s

# -------- Frontends --------
frontend f_events
bind *:1514
default_backend b_events

frontend f_enroll
bind *:1515
default_backend b_enroll

# -------- Backends --------
backend b_events
balance leastconn
option tcp-check
# Keep running even if name can't be resolved immediately; resolve at runtime
default-server inter 3s fall 3 rise 2 resolvers docker resolve-prefer ipv4 init-addr last,libc,none
server m1 wazuh-manager-1:1514 check
server m2 wazuh-manager-2:1514 check

backend b_enroll
balance leastconn
option tcp-check
default-server inter 3s fall 3 rise 2 resolvers docker resolve-prefer ipv4 init-addr last,libc,none
server m1 wazuh-manager-1:1515 check
server m2 wazuh-manager-2:1515 check
